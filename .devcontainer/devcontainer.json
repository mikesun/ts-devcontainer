{
	"name": "ts-devcontainer",
	"image": "mcr.microsoft.com/devcontainers/typescript-node:dev-24-trixie",
	"features": {
		"ghcr.io/devcontainers/features/sshd:1": { "version": "latest", "gatewayPorts": "yes" },
		"ghcr.io/devcontainers/features/docker-in-docker:2": {
			"version": "latest",
			"moby": false
		},
		"ghcr.io/devcontainers/features/rust:1.5.0": { "version": "latest" },
		"ghcr.io/devcontainers/features/terraform:1.4.2": {}
	},
	"appPort": [3000],
	"runArgs": ["--privileged"],
	"containerEnv": {
		"WORKSPACE_DIR": "${containerWorkspaceFolder}"
	},

	"mounts": [
		// persistent home dir
		"type=volume,source=ts-devcontainer-home,target=/home/node",

		// allow ssh agent forwarding
		"type=bind,source=/run/host-services/ssh-auth.sock,target=/run/host-services/ssh-auth.sock",

		// persist inner docker images/volumes across rebuilds
		"type=volume,source=ts-devcontainer-dind-var-lib-docker,target=/var/lib/docker"
	],

	"remoteEnv": {
		"SSH_AUTH_SOCK": "/tmp/ssh-agent.sock"
	},

	"postCreateCommand": "bash -lc '.devcontainer/scripts/postCreate.sh'",
	"postStartCommand": "sudo -E bash -lc '.devcontainer/scripts/postStart.sh'"
}
